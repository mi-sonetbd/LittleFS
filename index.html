<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LittleFS Disk Image Viewer</title>
    <link href="tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mx-auto">
        <h1 class="text-xl my-2">LittleFS Disk Image Viewer</h1>
        <div id="content"></div>
    </div>

    <!-- Include the Wasmer WASI JavaScript library -->
    <script type="module">
        import { WASI } from 'https://cdn.jsdelivr.net/npm/@wasmer/wasi@latest/lib/index.esm.js';
        import { WasmFs } from 'https://cdn.jsdelivr.net/npm/@wasmer/wasmfs@latest/lib/index.esm.js';

        const wasmFs = new WasmFs();
        const wasi = new WASI({
            args: [],
            env: {},
            bindings: {
                ...WASI.defaultBindings,
                fs: wasmFs.fs,
            }
        });

        // Define the traverseCallback function required by the WebAssembly module
        function traverseCallback() {
            console.log('traverseCallback function called from WebAssembly');
            // Add any specific logic here if required by your WASM module
            return 0; // Return an appropriate value if needed by your WASM module
        }

        async function runWasm() {
            try {
                // Fetch and instantiate the WebAssembly module
                const response = await fetch('main.async.wasm');
                if (!response.ok) {
                    throw new Error(`Failed to fetch WASM module: ${response.statusText}`);
                }

                const buffer = await response.arrayBuffer();
                const { instance } = await WebAssembly.instantiate(buffer, {
                    wasi_snapshot_preview1: wasi.wasiImport,
                    env: {
                        memory: new WebAssembly.Memory({ initial: 256, maximum: 512 }),
                        traverseCallback: traverseCallback,
                        // Add other imports expected by the 'env' object here if required.
                    }
                });

                // Start the WASI instance
                wasi.start(instance);

                // Display output (if your WASM module uses stdout)
                const output = wasmFs.getStdOut();
                document.getElementById('content').textContent = `Output:\n${output}`;
            } catch (err) {
                console.error('Error running WebAssembly:', err);
                document.getElementById('content').textContent = `Failed to run WebAssembly module: ${err.message}`;
            }
        }

        runWasm();
    </script>
</body>
</html>
